THREE.extend(THREE.Vector3.prototype,{getQuatRotationTo:function(a){var b=this.clone().normalize(),c=a.clone().normalize(),d=b.dot(c);a=new THREE.Quaternion;if(!(1<=d))if(-0.999999>d)c=(new THREE.Vector3(1,0,0)).cross(b),0===c.lengthSq()&&(c=(new THREE.Vector3(0,1,0)).cross(b)),c.normalize(),a.setFromAxisAngle(c,Math.PI);else{var d=Math.sqrt(2*(1+d)),f=1/d,b=b.cross(c);a.x=b.x*f;a.y=b.y*f;a.z=b.z*f;a.w=0.5*d;a.normalize()}return a},setEulerFromAxisAngle:function(a,b){var c=(new THREE.Quaternion).setFromAxisAngle(a,
b);this.setEulerFromQuaternion(c);return this}});THREE.extend(THREE.EventDispatcher.prototype,{removeAllEventListeners:function(){if(void 0!==this._listeners){for(var a in this._listeners)this._listeners.hasOwnProperty(a)&&void 0!==this._listeners[a]&&(this._listeners[a].length=0);this._listeners=void 0}}});
THREE.extend(THREE.Matrix3.prototype,{inverse:function(a){var b=this.determinant();if(0===b){if(a)throw Error("Matrix3.inverse(): can't invert matrix, determinant is 0");console.warn("Matrix3.inverse(): can't invert matrix, determinant is 0");this.identity();return this}a=this.elements;this.set(a[4]*a[8]-a[7]*a[5],a[6]*a[5]-a[3]*a[8],a[3]*a[7]-a[6]*a[4],a[7]*a[2]-a[1]*a[8],a[0]*a[8]-a[6]*a[2],a[6]*a[1]-a[0]*a[7],a[1]*a[5]-a[4]*a[2],a[3]*a[2]-a[0]*a[5],a[0]*a[4]-a[3]*a[1]);return this.multiplyScalar(1/
b)},add:function(a){for(var b=this.elements.length,c=0;c<b;c++)this.elements[c]+=a.elements[c];return this},multiply:function(a){var b=this.elements;a=a.elements;return this.set(b[0]*a[0]+b[3]*a[1]+b[6]*a[2],b[0]*a[3]+b[3]*a[4]+b[6]*a[5],b[0]*a[6]+b[3]*a[7]+b[6]*a[8],b[1]*a[0]+b[4]*a[1]+b[7]*a[2],b[1]*a[3]+b[4]*a[4]+b[7]*a[5],b[1]*a[6]+b[4]*a[7]+b[7]*a[8],b[2]*a[0]+b[5]*a[1]+b[8]*a[2],b[2]*a[3]+b[5]*a[4]+b[8]*a[5],b[2]*a[6]+b[5]*a[7]+b[8]*a[8])},makeRotationFromQuaternion:function(a){var b=this.elements,
c=a.x,d=a.y,f=a.z,e=a.w,g=c+c,h=d+d,q=f+f;a=c*g;var l=c*h,c=c*q,r=d*h,d=d*q,f=f*q,g=e*g,h=e*h,e=e*q;b[0]=1-(r+f);b[3]=l-e;b[6]=c+h;b[1]=l+e;b[4]=1-(a+f);b[7]=d-g;b[2]=c-h;b[5]=d+g;b[8]=1-(a+r);return this}});THREE.extend(THREE.Plane.prototype,{collide:function(a){return a.collidePlane(this)}});THREE.extend(THREE.Quaternion.prototype,{dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z+this.w*a.w}});function AssociativeArray(){this.length=0}
AssociativeArray.prototype={constructor:AssociativeArray,add:function(a,b){this.isKey(a)||this.length++;return this[a]=b},remove:function(a){void 0!==this[a]&&(this.length--,delete this[a])},get:function(a){var b=0,c=void 0;this.some(function(d,f){return b++===a?(c={key:f,value:d},!0):!1});return c},concat:function(a){var b=this;a.forEach(function(a,d){b.add(d,a)})},isKey:function(a){return this.hasOwnProperty(a)&&"length"!==a},some:function(a){for(var b in this)if(this.isKey(b)&&a(this[b],b))return!0;
return!1},forEach:function(a,b){for(var c in this)this.hasOwnProperty(c)&&"length"!==c&&a.call(b,this[c],c)},clone:function(){var a=new AssociativeArray,b;for(b in this)this.isKey(k)&&a.add(b,this[b]);return a}};
function CollisionHandler(a){this.handleCollision=function(a,c,d){function f(a,b,c,d){if(!a._immovable_direction.equals(H)){var e=c.dot(a._immovable_direction);0<e&&(e=a._immovable_direction.clone().multiplyScalar(e).negate(),c.add(e),d.add(e));e=d.dot(a._immovable_direction);0<e&&(e=a._immovable_direction.clone().multiplyScalar(e).negate(),d.add(e),c.add(e));b._immovable_direction.set(a._immovable_direction.x,a._immovable_direction.y,a._immovable_direction.z)}}function e(a,b,c,d,e,f,g,l){(0===a._immovable_direction.lengthSq()||
0!==a._immovable_direction.lengthSq()&&0.99>d.dot(a._immovable_direction))&&a._velocity.add(d);a._velocity.add(f);a._angular_velocity.add(g);a._angular_velocity.add(e);l&&a._angular_velocity.multiplyScalar(1-E);b=b._id;d=a._rolling_velocities;e=d[b];void 0===e&&(e=d.add(b,new THREE.Vector3));b=e;c=a._angular_velocity.clone().cross(p).cross(p).cross(c).multiplyScalar(E);b.set(c.x,c.y,c.z);if(0.1<a.getVelocity().lengthSq()||0.1<a.getAngularVelocity().lengthSq())a._is_sleeping=!1}a.isKinematic();c.isKinematic();
var g=a.isDynamic(),h=c.isDynamic(),q=a.getAngularVelocity(),l=c.getAngularVelocity(),r=a._velocity.clone(),n=c._velocity.clone(),p=d.report.axis.clone(),m,s,t=d.report.colliding_primitive1,v=d.report.colliding_primitive2,w=d.report.contact1.clone().applyQuaternion(a._orientation),y=d.report.contact2.clone().applyQuaternion(c._orientation),F=!1,G=!1,x=t instanceof VolumeFace,D=v instanceof VolumeFace;m=a.collider;s=c.collider;var u=x?m.getDerivedVertices():void 0,z=D?s.getDerivedVertices():void 0,
C=x?m.projectCenterOnFace(u[t.vertices[0]],t.getNormal(u)):void 0,A=D?s.projectCenterOnFace(z[v.vertices[0]],v.getNormal(z)):void 0;if(x&&D){A.clone().sub(C).divideScalar(2);var B=function(a,b,c,d,e,f,g){e=e.getFaceVertices(d);a=ConvexHull.prototype.findFaceEdgeIntersection(e,d.getNormal(c),a,b,a);f.set(a.x,a.y,a.z)};5<Math.abs(Math.abs(r.dot(p))-Math.abs(n.dot(p)))?(B(C,A,z,v,s,w,y),B(A,C,u,t,m,y,w),0>n.clone().sub(r).dot(p)?(w=y.clone().add(w.sub(y).multiplyScalar(Math.min(a._mass/c._mass,1))),
y=w.clone().sub(d.report.penetration)):(y=w.clone().add(y.sub(w).multiplyScalar(Math.min(a._mass/c._mass,1))),w=y.clone().sub(d.report.penetration.clone().negate()))):(B(C,A,z,v,s,w,y),B(A,C,u,t,m,y,w));w.sub(a.getPosition());y.sub(c.getPosition())}x&&(t=t.getNormal(a.collider.getDerivedVertices()),t=t.getQuatRotationTo(p),a.rotate(t),w.applyQuaternion(t),F=0.1>a.getPosition().add(w).sub(C).length()&&(s instanceof Plane||D));D&&(t=v.getNormal(c.collider.getDerivedVertices()),t=t.getQuatRotationTo(p.clone().negate()),
c.rotate(t),y.applyQuaternion(t),G=0.1>c.getPosition().add(y).sub(A).length()&&(m instanceof Plane||x));v=r.clone().add(q.clone().cross(w));A=n.clone().add(l.clone().cross(y));D=A.clone().sub(v);x=v.dot(p);m=A.dot(p);x=Math.abs(x);m=Math.abs(m);s=x+m;0===s?(x=g&&h?0.5:g?1:0,C=g&&h?0.5:h?1:0):(x=0===s?0.5:x/s,C=0===s?0.5:m/s);var H=new THREE.Vector3;m=d.report.penetration.clone().multiplyScalar(-x);s=d.report.penetration.clone().multiplyScalar(C);f(a,c,m,s);f(c,a,s,m);0.99<x?a._immovable_direction_new=
p.clone():0.99<C&&(c._immovable_direction_new=p.clone().negate());a._position.add(m);c._position.add(s);if(!(0>r.dot(d.report.penetration)&&0<n.dot(d.report.penetration))){t=q.clone();u=l.clone();x=u.clone().sub(t);m=(a.restitution+c.restitution)/2;var E=a.friction*c.friction,B=5<Math.abs(Math.abs(r.dot(p))-Math.abs(n.dot(p)));s=w.clone().cross(p);C=y.clone().cross(p);t=s.clone().cross(w);u=C.clone().cross(y);A=0<A.dot(a._immovable_direction)&&a.getPosition().dot(a._immovable_direction)>c.getPosition().dot(a._immovable_direction);
z=0<v.dot(c._immovable_direction)&&c.getPosition().dot(c._immovable_direction)>a.getPosition().dot(c._immovable_direction);d=A&&!B?new THREE.Matrix3(Infinity,0,0,0,Infinity,0,0,0,Infinity):a.getGlobalInertiaTensor();v=z&&!B?new THREE.Matrix3(Infinity,0,0,0,Infinity,0,0,0,Infinity):c.getGlobalInertiaTensor();d=0===d.determinant()||A&&!B?new THREE.Matrix3(0,0,0,0,0,0,0,0,0):d.inverse();v=0===v.determinant()||z&&!B?new THREE.Matrix3(0,0,0,0,0,0,0,0,0):v.inverse();B=t.applyMatrix3(d).add(u.applyMatrix3(v)).dot(p);
t=A?Infinity:a._mass;u=z?Infinity:c._mass;D=D.dot(p);A=1/(1/a._mass+1/c._mass+B);B=1/(1/t+1/u+B);z=(1+m)*D*B;m=p.clone().multiplyScalar((1+m)*D*B);D=m.clone().divideScalar(t);m=m.clone().divideScalar(u);s=s.clone().applyMatrix3(d).multiplyScalar(z);C=C.clone().applyMatrix3(v).multiplyScalar(z);z=n.clone().sub(r);z.length();B=z.dot(p);r=new THREE.Vector3;n=new THREE.Vector3;0!==B&&(t=u=0,r=z.clone().sub(p.clone().multiplyScalar(B)).normalize(),n=z.dot(r),u=(E+u)*n*A,n=(E+t)*n*A,A=r.clone().multiplyScalar(u),
n=r.clone().multiplyScalar(n),r=A.clone().divideScalar(a._mass),n=n.clone().divideScalar(c._mass));A=new THREE.Vector3;t=new THREE.Vector3;0<x.lengthSq()&&(x.dot(p),w.length(),x.dot(p),y.length(),t=u=0,w.clone().length(),q.dot(p),y.clone().length(),l.dot(p),q=d.clone().add(v).inverse(),l=x.dot(p),q=p.clone().applyMatrix3(q),x=l*(E+u),l*=E+t,x=q.clone().multiplyScalar(x),q=q.clone().multiplyScalar(l),A=x.clone().applyMatrix3(d),t=q.clone().applyMatrix3(v));g&&e(a,c,w,D,s,r,A,F);h&&e(c,a,y,m.negate(),
C.negate(),n.negate(),t.negate(),G);a.contact_points.add(c._id,w);c.contact_points.add(a._id,y)}};this.handleCollisionOut=function(b){var c=a[b.report.object1._id],d=a[b.report.object2._id];c._rolling_velocities.forEach(function(a,b){b==d._id&&(void 0!==d&&(0>d._velocity.dot(c._velocity)&&5<d._velocity.clone().sub(c._velocity).length())&&c._velocity.add(a.multiplyScalar((c.restitution+d.restitution)/2)),c.contact_points.remove(b),c._rolling_velocities.remove(b))})};this.handleRestingPoses=function(b){b.forEach(function(b,
d){var f=a[b.object1._id],e=a[b.object2._id];0.1>e._velocity.clone().sub(f._velocity).length()&&0.01>e._angular_velocity.clone().sub(f._angular_velocity).length()&&(f._velocity.set(0,0,0),e._velocity.set(0,0,0),f.acceleration.set(0,0,0),e.acceleration.set(0,0,0),f._is_sleeping=!0,e._is_sleeping=!0,0!==f._immovable_direction_new.lengthSq()&&(f._immovable_direction.set(f._immovable_direction_new.x,f._immovable_direction_new.y,f._immovable_direction_new.z),f._immovable_direction_new.set(0,0,0)),0!==
e._immovable_direction_new.lengthSq()&&(e._immovable_direction.set(e._immovable_direction_new.x,e._immovable_direction_new.y,e._immovable_direction_new.z),e._immovable_direction_new.set(0,0,0)))})}}function CollisionReport(a,b){this.penetration=void 0;this.object1=a;this.object2=b;this.collide=this.contact2=this.contact1=void 0;this.collision_pairs=new AssociativeArray}
function CollisionDetector(a){function b(b){var c=a.find(b._id),e=[],g=b._id;if(void 0!==c)for(c._all_volumes.forEach(function(a,b){b!=g&&e.push(a[0])});null!==c.parent_node;){b=c.parent_node.volumes.length;for(var h=0;h<b;h++)c.parent_node.volumes[h]._id!==g&&e.push(c.parent_node.volumes[h]);c=c.parent_node}return e}this.addEventListener=THREE.EventDispatcher.prototype.addEventListener;this.hasEventListener=THREE.EventDispatcher.prototype.hasEventListener;this.removeEventListener=THREE.EventDispatcher.prototype.removeEventListener;
this.dispatchEvent=THREE.EventDispatcher.prototype.dispatchEvent;this.collisionEnteredEvent={type:"collisionentered",report:void 0};this.collisionExitedEvent={type:"collisionexited",report:void 0};this.previous_collisions=new AssociativeArray;var c=0;this.update=function(a){this.collision_pairs=new AssociativeArray;var f=this;c++;a.forEach(function(c,g){if(!c.isStatic()&&!c._is_sleeping)for(var h=c.collider,q=b(h),l=q.length,r=0;r<l;r++){var n=q[r],p=a[n._id];if(void 0===c.sphere||void 0===p.sphere||
c.sphere.collide(p.sphere)){var p=n._id+"-"+h._id,m=h._id+"-"+n._id,s=f.collision_pairs[p]||f.collision_pairs[m];void 0===s&&(s=new CollisionReport(h,n),s.collide=h.collide(n,s),f.collision_pairs.add(m,s),s.collide&&(f.collisionEnteredEvent.report=s,f.dispatchEvent(f.collisionEnteredEvent)));s.collide||(n=f.previous_collisions[p]||f.previous_collisions[m],void 0!==n&&n.collide&&(f.collisionExitedEvent.report=s,f.dispatchEvent(f.collisionExitedEvent)),f.collision_pairs.remove(p),f.collision_pairs.remove(m))}}});
this.previous_collisions=this.collision_pairs};return this}function Menu(a){this.container=a;this.buttons=[];a=this.container.find("a");for(var b=0;b<a.length;b++)this.buttons[a[b].getAttribute("id")]=a[b]}
Menu.prototype={constructor:Menu,center:function(){var a=window.innerHeight/2-parseInt(this.container.css("height"))/2;this.container.css("top",a+"px");a=window.innerWidth/2-parseInt(this.container.css("width"))/2;this.container.css("left",a+"px")},hide:function(){this.container.css("visibility","hidden")}};
function InputListener(a){this.mouseDown=!1;this.keyPressed={};this.click_position=new THREE.Vector3;this.mouse_up_position=new THREE.Vector3;this.current_mouse_position=new THREE.Vector3;this.event_stack=[];var b=!1,c=this;this.useEventStack=function(a){b=a};this.emptyEventStack=function(){c.event_stack.length=0};this.onCanvasMouseOver=function(a){b&&c.event_stack.push(a)};this.onCanvasMouseOut=function(a){b&&c.event_stack.push(a)};this.onDocumentMouseMove=function(a){a.preventDefault();c.current_mouse_position.x=
2*(a.clientX/window.innerWidth)-1;c.current_mouse_position.y=2*-(a.clientY/window.innerHeight)+1;b&&c.event_stack.push(a)};this.onDocumentMouseUp=function(a){a.preventDefault();mouse_down=!1;c.mouse_up_position.x=2*(a.clientX/window.innerWidth)-1;c.mouse_up_position.y=2*-(a.clientY/window.innerHeight)+1;b&&c.event_stack.push(a)};this.onDocumentMouseDown=function(a){a.preventDefault();mouse_down=!0;c.click_position.x=2*(a.clientX/window.innerWidth)-1;c.click_position.y=2*-(a.clientY/window.innerHeight)+
1;b&&c.event_stack.push(a)};this.onDocumentKeyDown=function(a){c.keyPressed[a.keyCode]=!0;b&&c.event_stack.push(a)};this.onDocumentKeyUp=function(a){c.keyPressed[a.keyCode]=!1;b&&c.event_stack.push(a)};document.addEventListener("mousemove",this.onDocumentMouseMove,!1);document.addEventListener("keydown",this.onDocumentKeyDown,!1);document.addEventListener("keyup",this.onDocumentKeyUp,!1);a.addEventListener("mouseover",this.onCanvasMouseOver,!1);a.addEventListener("mouseout",this.onCanvasMouseOut,
!1);a.addEventListener("mousedown",this.onDocumentMouseDown,!1);a.addEventListener("mouseup",this.onDocumentMouseUp,!1)}function VolumeFace(a,b){this.vertices=a;this._center=b;this._proj_center_length=this._proj_center_norm=void 0}
VolumeFace.prototype={constructor:VolumeFace,clone:function(){for(var a=[],b=this.vertices.length,c=0;c<b;c++)a.push(this.vertices[c].clone());return new VolumeFace(a,void 0!==this._center?this._center.clone():void 0)},getNormal:function(a){var b=a[this.vertices[1]],c=a[this.vertices[2]];a=a[this.vertices[0]].clone().sub(b);return c.clone().sub(b).cross(a).normalize()},contains:function(a,b,c){function d(a,b,c,d){var f,g,h=0;f=0;for(g=e-1;f<e;g=f++)b[f]>d!=b[g]>d&&c<(a[g]-a[f])*(d-b[f])/(b[g]-b[f])+
a[f]&&(h=!h);return h}for(var f=new THREE.Vector3,e=a.length,g=0;g<e;g++)f.add(a[g]);f.divideScalar(e);if(0.01<c.clone().sub(f).dot(b))return!1;for(var f=[],h=[],q=[],g=0;g<e;g++)f.push(a[g].x),h.push(a[g].y),q.push(a[g].z);b=new THREE.Vector3(Math.abs(b.x),Math.abs(b.y),Math.abs(b.z));if(b.x>b.y&&b.x>b.z)return d(h,q,c.y,c.z);if(b.y>b.x&&b.y>b.z)return d(f,q,c.x,c.z);if(b.z>b.y&&b.z>b.x)return d(f,h,c.x,c.y)}};function VolumeEdge(a,b){this.p1=a;this.p2=b}
VolumeEdge.prototype={constructor:VolumeEdge,clone:function(){return new VolumeEdge(this.p1,this.p2,void 0!==this._center?this._center.clone():void 0)},intersectEdge:function(a,b,c,d){b=b.clone().sub(a);var f=d.clone().sub(c);d=b.clone().cross(f);if(0!==d.length()){c=c.clone().sub(a).cross(f);var e;d.x>d.y&&d.x>d.z?e=c.x/d.x:d.y>d.x&&d.y>d.z?e=c.y/d.y:d.z>d.y&&d.z>d.x&&(e=c.z/d.z);if(1>=e&&0<=e)return b.multiplyScalar(e).add(a)}}};
function Volume(a,b){this._position=a;this._orientation=b;this._id=-1;this.mesh=void 0}
Volume.prototype={constructor:Volume,volumes_node:new THREE.Object3D,destroy:function(){if(void 0!==this.mesh&&void 0!==this.mesh.parent){this.mesh.parent.remove(this.mesh);for(var a=0;a<this.mesh.children.length;a++)this.mesh.remove(this.mesh.children[a])}},collidePlane:function(a){throw"collidePlane function undefined for this volume type.";},collideConvexShape:function(a){throw"collideConvexShape function undefined for this volume type.";},collideSphere:function(a){throw"collideSphere function undefined for this volume type.";
},collideOBB:function(a){throw"collideSphere function undefined for this volume type.";},collide:function(a,b){if(a instanceof Sphere)return this.collideSphere(a);if(this instanceof OBB&&a instanceof OBB)return this.collideOBB(a,b);if(this instanceof ConvexHull&&a instanceof ConvexHull)return this.collideConvexShape(a,b);if(this instanceof Plane&&a instanceof ConvexHull)return a.collidePlane(this,b);if(a instanceof Plane&&this instanceof ConvexHull)return this.collidePlane(a,b)},getExposedArea:function(a){throw"getExposedArea function undefined for this volume type.";
},getContactPointsWithPlane:function(a){throw"getContactPointsWithPlane function undefined for this volume type.";},getRotationToRestPose:function(){throw"getRotationToRestPose function undefined for this volume type.";},intersectPlane:function(a,b){throw"intersectPlane function undefined for this volume type.";},findFaceClosestTo:function(a,b,c){throw"getFartherPointFromLine function undefined for this volume type.";},getFace:function(a){for(var b=0;b<this._faces.length;b++)for(var c=0,d=this._faces[b].vertices,
f=0;f<d.length;f++){for(var e=0;e<a.length;e++)if(d[f]===a[e]){c++;break}if(3<=c)return this._faces[b]}},getPosition:function(){return this._position.clone()},getOrientation:function(){return this._orientation.clone()},bind:function(a){this._position=a._position;this._orientation=a._orientation;void 0!==this.mesh&&(this.mesh.position=this._position,this.mesh.quaternion=this._orientation);this._id=a._id},unbind:function(){this._position=this._position.clone();this._orientation=this._orientation.clone();
void 0!==this.mesh&&(this.mesh.position=this._position,this.mesh.quaternion=this._orientation);this._id=void 0}};function Sphere(a,b){Volume.call(this,a,new THREE.Quaternion);this.radius=b;var c=new THREE.SphereGeometry(b);this.mesh=new THREE.Mesh(c,new THREE.MeshBasicMaterial({color:0,opacity:1,wireframe:!0}));this.mesh.position=this._position;this.mesh.useQuaternion=!0;this.volumes_node.add(this.mesh)}Sphere.prototype=Object.create(Volume.prototype);Sphere.prototype.constructor=Sphere;
Sphere.prototype.collideSphere=function(a){var b=this.radius+a.radius;return this._position.clone().sub(a._position).lengthSq()<=b*b};function Plane(a,b,c,d){Volume.call(this,new THREE.Vector3,new THREE.Quaternion);THREE.Plane.call(this,a,b);this.width=c;this.height=d}Plane.prototype=Object.create(Volume.prototype);for(var attr in THREE.Plane.prototype)THREE.Plane.prototype.hasOwnProperty(attr)&&(Plane.prototype[attr]=THREE.Plane.prototype[attr]);Plane.prototype.constructor=Plane;
Plane.prototype.calculateInertiaTensor=function(a,b,c,d,f){f.set(0,0,0,0,0,0,0,0,0)};function ConvexHull(a,b){Volume.call(this,a,b);this._vertices=[];this._faces=[];this._edges=[];this._derived_vertices=[];this._center=new THREE.Vector3;this._derived_center=this._center.clone();this.prev_position=new THREE.Vector3;this.prev_orientation=new THREE.Vector3}ConvexHull.prototype=Object.create(Volume.prototype);ConvexHull.prototype.constructor=ConvexHull;
ConvexHull.prototype.getFaceVertices=function(a){for(var b=this.getDerivedVertices(),c=[],d=a.vertices.length,f=0;f<d;f++)c.push(b[a.vertices[f]]);return c};
ConvexHull.prototype.findFaceEdgeIntersection=function(a,b,c,d,f){var e=c.clone().sub(a[0]);c=c.clone().add(b.clone().multiplyScalar(-e.dot(b)));e=d.clone().sub(a[0]);d=d.clone().add(b.clone().multiplyScalar(-e.dot(b)));e=f.clone().sub(a[0]);f=f.clone().add(b.clone().multiplyScalar(-e.dot(b)));if(VolumeFace.prototype.contains(a,b,f))return f;var g,h;b=0;for(e=a.length-1;b<a.length;b++,e=b-1)if(e=VolumeEdge.prototype.intersectEdge(a[b],a[e],c,d),void 0!==e){var q=e.clone().sub(f).lengthSq();if(void 0===
g||q<g)h=e,g=q}return h};
ConvexHull.prototype.findContactPoints=function(a,b,c){function d(a,b,c,d,e){a=(new Plane).setFromNormalAndCoplanarPoint(a,b[0]);for(var f=Math.abs(a.distanceToPoint(c[0])),p=new THREE.Vector3,m=0;m<b.length;m++)p.add(b[m]);p.divideScalar(b.length);d.push(0);for(m=1;m<c.length;m++)void 0!==c[m]&&(b=Math.abs(a.distanceToPoint(c[m].clone().add(e))),Math.abs(b-f)<COLLISION_THRESHOLD?d.push(m):b<f&&(d.length=0,d.push(m),sum=1,f=b))}function f(a,b,c,e,f,n){var p=a.getFaceVertices(b);b=e.getDerivedVertices().slice();
d(c.clone().negate(),p,b,n,f);var m=n.length;if(2<m)return p=a.projectCenterOnFace(p[0],c),c=e.projectCenterOnFace(b[n[0]],c.clone().negate()),p.add(c.add(f)).divideScalar(2);if(1===m)return b[n[0]].clone().add(f);if(2===m){a=[];for(var s=new THREE.Vector3,m=0;m<p.length;m++)s.add(p[m]);s.divideScalar(p.length);for(m=0;m<p.length;m++){var t=p[m].clone().sub(s).normalize().multiplyScalar(2);a.push(p[m].clone().add(t))}m=e.projectCenterOnEdge(b[n[0]],b[n[1]]);for(s=ConvexHull.prototype.findFaceEdgeIntersection(a,
c,b[n[0]],b[n[1]],m);void 0===s&&0<b.length;){for(m=0;m<n.length;m++)b[n[m]]=void 0;n.length=0;d(c.clone().negate(),p,b,n,f);2===n.length&&(m=e.projectCenterOnEdge(b[n[0]],b[n[1]]),s=ConvexHull.prototype.findFaceEdgeIntersection(a,c,b[n[0]],b[n[1]],m))}return s}}if(a.colliding_primitive1 instanceof VolumeFace){var e=[];a.contact1=f(b,a.colliding_primitive1,a.axis,c,a.penetration,e);a.contact2=a.contact1.clone().sub(a.penetration);2<e.length?a.colliding_primitive2=c.getFace(e):2===e.length&&(a.colliding_primitive2=
new VolumeEdge(e[0],e[1]))}else a.colliding_primitive2 instanceof VolumeFace?(e=[],a.contact2=f(c,a.colliding_primitive2,a.axis.clone().negate(),b,a.penetration.clone().negate(),e),a.contact1=a.contact2.clone().add(a.penetration),2<e.length?a.colliding_primitive1=b.getFace(e):2===e.length&&(a.colliding_primitive1=new VolumeEdge(e[0],e[1]))):a.colliding_primitive1 instanceof VolumeEdge&&a.colliding_primitive2 instanceof VolumeEdge&&(e=a._intersection,a.contact1=e.clone(),a.contact2=e.clone().add(a.penetration));
a.contact1.sub(b._position).applyQuaternion(b._orientation.clone().inverse());a.contact2.sub(c._position).applyQuaternion(c._orientation.clone().inverse())};
ConvexHull.prototype.isSeparatingAxis=function(a,b,c,d,f,e){if(0.1>a.lengthSq())return!1;for(var g=b.getDerivedVertices(),h=c.getDerivedVertices(),q=0,l=0,r=0,n=0,p=0;p<g.length;p++){var m=g[p].clone().sub(b._position).dot(a);m>q?q=m:m<r&&(r=m)}for(p=0;p<h.length;p++)m=h[p].clone().sub(c._position).dot(a),m<l?l=m:m>n&&(n=m);g=b.getPosition().add(a.clone().multiplyScalar(q)).dot(a);h=c.getPosition().add(a.clone().multiplyScalar(l)).dot(a);r=b.getPosition().add(a.clone().multiplyScalar(r)).dot(a);n=
c.getPosition().add(a.clone().multiplyScalar(n)).dot(a);n=0<g-h&&0<r-n||-0>g-h&&-0>r-n;r=Math.abs(g-h);if(void 0!==d)if(f instanceof VolumeEdge){if(g=void 0!==d._intersection,!g&&d._shortest_dist-COLLISION_THRESHOLD>r||g&&d._shortest_dist>=r||void 0===d._shortest_dist)g=b.getDerivedVertices(),h=c.getDerivedVertices(),l=(new Plane).setFromNormalAndCoplanarPoint(a,g[f.p1]),b=l.distanceToPoint(h[e.p1]),c=l.projectPoint(h[e.p1]),h=l.projectPoint(h[e.p2]),c=VolumeEdge.prototype.intersectEdge(g[f.p1],g[f.p2],
c,h),void 0!==c&&(void 0===d._edge_distance||b<d._edge_distance)&&(d._edge_distance=b,d._intersection=c,d._shortest_dist=r,d.colliding_primitive1=f,d.colliding_primitive2=e,d.axis=a.clone())}else if(void 0===d._shortest_dist||d._shortest_dist>r)d._shortest_dist=r,d.colliding_primitive1=f,d.colliding_primitive2=e,d.axis=a.clone();return n};
ConvexHull.prototype.updateReport=function(a,b){if(void 0!==a){var c=this._position.clone().sub(b._position).lengthSq();a.penetration=a.axis.clone().multiplyScalar(Math.abs(a._shortest_dist));var d=a.penetration.clone().add(this._position).sub(b._position).lengthSq();c<d&&(a.axis.negate(),a.penetration.negate());this.findContactPoints(a,this,b)}};
ConvexHull.prototype.collideConvexShape=function(a,b){var c=new THREE.Vector3;c.subVectors(a._position,this._position);for(var d=this.getDerivedVertices(),f=a.getDerivedVertices(),e=0;e<this._faces.length;e++){var g=this._faces[e].getNormal(d);if(this.isSeparatingAxis(g,this,a,b,this._faces[e],void 0))return!1}for(e=0;e<a._faces.length;e++)if(g=a._faces[e].getNormal(f),this.isSeparatingAxis(g,a,this,b,void 0,a._faces[e]))return!1;for(e=0;e<this._edges.length;e++)for(var h=0;h<a._edges.length;h++){var g=
f[a._edges[h].p2].clone().sub(f[a._edges[h].p1]),q=d[this._edges[e].p2].clone().sub(d[this._edges[e].p1]),g=(new THREE.Vector3).crossVectors(q,g).normalize();0>c.dot(g)&&g.negate();if(this.isSeparatingAxis(g,this,a,b,this._edges[e],a._edges[h]))return!1}this.updateReport(b,a);return!0};ConvexHull.prototype.collideSphere=function(a){throw"collideSphere function undefined for this volume type.";};
ConvexHull.prototype.collidePlane=function(a,b){for(var c=this.getDerivedVertices(),d=[0],f=a.distanceToPoint(c[0]),e=c.length,g=1,h,q=c[0],l=1;l<e;l++){var r=c[l].clone(),r=a.distanceToPoint(r);Math.abs(r-f)<COLLISION_THRESHOLD?(d.push(l),g++):r<f&&(f=r,d.length=0,d.push(l),g=1,q=c[l])}if(void 0!==b&&0>=f){var n;if(2===g){for(l=0;l<this._edges.length;l++)if(e=this._edges[l].p1,g=this._edges[l].p2,e===d[0]&&g===d[1]||e===d[1]&&g===d[0]){h=new VolumeEdge(c[e],c[g]);n=this.projectCenterOnEdge(c[e],
c[g]);break}if(void 0===n)for(e=d.length,l=0;l<this._faces.length;l++){for(var g=0,r=this._faces[l].vertices,p=0;p<r.length;p++){for(var m=0;m<e;m++)if(d[m]===r[p]){g++;break}if(2===g)break}if(2<=g){h=this._faces[l];n=this.projectCenterOnFace(c[r[0]],this._faces[l].getNormal(c));break}}}else if(2<g)for(e=d.length,l=0;l<this._faces.length;l++){g=0;r=this._faces[l].vertices;for(p=0;p<r.length;p++){for(m=0;m<e;m++)if(d[m]===r[p]){g++;break}if(3===g)break}if(3<=g){h=this._faces[l];n=this.projectCenterOnFace(c[r[0]],
this._faces[l].getNormal(c));break}}else n=c[d[0]];b.penetration=a.orthoPoint(q).negate();b.axis=a.normal.clone();b.object1=a;b.object2=this;b.contact1=n.clone().add(b.penetration);b.contact2=n.clone().sub(this._position).applyQuaternion(this._orientation.clone().inverse());b.colliding_primitive2=h}return 0>=f};ConvexHull.prototype.collideOBB=function(a){return this.collideConvexShape(a)};
ConvexHull.prototype.getContactPointsWithPlane=function(a){for(var b=this.getDerivedVertices(),c=[],d=0;d<b.length;d++)a.distanceToPoint(b[d])<COLLISION_THRESHOLD&&c.push(b[d].clone());return c};
ConvexHull.prototype.updateDerived=function(a){if(a||!this._position.equals(this.prev_position)||!this._orientation.equals(this.prev_orientation)){this._derived_vertices.length=0;a=(new THREE.Matrix4).makeFromPositionQuaternionScale(this._position,this._orientation,new THREE.Vector3(1,1,1));for(var b=0;b<this._vertices.length;b++)this._derived_vertices.push(this._vertices[b].clone().applyMatrix4(a));this._derived_center=this._center.clone().applyMatrix4(a);this.prev_position=this._position.clone();
this.prev_orientation=this._orientation.clone()}};ConvexHull.prototype.getDerivedVertices=function(){this.updateDerived();return this._derived_vertices};ConvexHull.prototype.getDerivedCenter=function(){this.updateDerived();return this._derived_center.clone()};ConvexHull.prototype.projectCenterOnEdge=function(a,b){var c=this.getDerivedCenter().sub(a),d=b.clone().sub(a).normalize();return a.clone().add(d.multiplyScalar(c.dot(d)))};
ConvexHull.prototype.projectCenterOnFace=function(a,b){var c=this.getDerivedCenter().sub(a);return c.add(b.clone().multiplyScalar(c.dot(b)).negate()).add(a)};ConvexHull.prototype.setCenter=function(a,b,c){this._center=new THREE.Vector3(a,b,c);this.updateDerived(!0)};
function OBB(a,b,c,d,f){if(0===c.lengthSq()||0===d.lengthSq()||0===f.lengthSq())throw"OBB axis must be greater than vector 0";ConvexHull.call(this,a,b);this.u=c;this.v=d;this.w=f;this.u_norm=c.clone().normalize();this.v_norm=d.clone().normalize();this.w_norm=f.clone().normalize();this.corners=[];a=[1,-1];for(b=0;2>b;b++)for(var e=0;2>e;e++)for(var g=0;2>g;g++){var h=this.u.clone(),q=this.v.clone(),l=this.w.clone();h.multiplyScalar(a[b]);q.multiplyScalar(a[e]);l.multiplyScalar(a[g]);h.add(q);h.add(l);
this.corners.push(h);this._vertices.push(h)}this._faces=[new VolumeFace([0,2,3,1]),new VolumeFace([0,1,5,4]),new VolumeFace([0,4,6,2]),new VolumeFace([4,5,7,6]),new VolumeFace([2,6,7,3]),new VolumeFace([1,3,7,5])];this._edges=[new VolumeEdge(0,1),new VolumeEdge(0,2),new VolumeEdge(0,4),new VolumeEdge(1,5),new VolumeEdge(1,3),new VolumeEdge(2,3),new VolumeEdge(2,6),new VolumeEdge(3,7),new VolumeEdge(4,5),new VolumeEdge(4,6),new VolumeEdge(5,7),new VolumeEdge(6,7)];this._derived_vertices=this.getDerivedVertices();
this._derived_axis=new THREE.Matrix3(this.u.x,this.u.y,this.u.z,this.v.x,this.v.y,this.v.z,this.w.x,this.w.y,this.w.z);f=new THREE.CubeGeometry(2*c.length(),2*d.length(),2*f.length());c=new THREE.Vector3(1,0,0);a=new THREE.Vector3(0,1,0);d=c.angleTo(this.u);c.cross(this.u.clone().normalize());a.applyAxisAngle(c,d);a=a.angleTo(this.v);f=new THREE.Mesh(f,new THREE.MeshBasicMaterial({color:0,opacity:1,wireframe:!0}));f.rotateOnAxis(c,d);f.rotateOnAxis(new THREE.Vector3(1,0,0),a);this.mesh=f;this.mesh.position=
this._position;this.mesh.quaternion=this._orientation;this.mesh.useQuaternion=!0;this.volumes_node.add(this.mesh)}OBB.prototype=Object.create(ConvexHull.prototype);OBB.prototype.constructor=OBB;
OBB.prototype.getExposedArea=function(a){var b,c,d;a=a.clone().normalize();b=Math.min(Math.abs(this.u_norm.dot(a)),Math.abs(this.u_norm.clone().negate().dot(a)));d=4*this.v.length()*this.w.length();c=Math.min(Math.abs(this.v_norm.dot(a)),Math.abs(this.v_norm.clone().negate().dot(a)));c<b&&(b=c,d=4*this.u.length()*this.w.length());c=Math.min(Math.abs(this.w_norm.dot(a)),Math.abs(this.w_norm.clone().negate().dot(a)));c<b&&(d=4*this.u.length()*this.v.length());return d};
OBB.prototype.findFaceClosestTo=function(a){for(var b=this._faces[0].normal.dot(a),c=this._faces.length,d=this._faces[0].clone(),f=this._faces[0].normal.clone().cross(a),e=0;e<c;e++){var g=this._faces[e].normal.dot(a);g>b&&(b=g,d=this._faces[e].clone(),f=this._faces[e].normal.clone().cross(a))}return{face:d,angle:Math.atan2(f,b)}};OBB.prototype.collideSphere=function(a){};
OBB.prototype.createOBB=function(a){for(var b=[],c=0,d=0;d<a.length;d++)for(var f=d+1;f<a.length;f++){var e=a[d].distanceToSquared(a[f]);e>c&&(b[0]=a[d],b[1]=a[f],c=e)}f=new THREE.Vector3;f.subVectors(b[0],b[1]);for(var c=0,g,h=f.clone().normalize(),q,d=0;d<a.length;d++){var l,r=a[d],n=b[1],e=h;l=new THREE.Vector3;l.subVectors(r,n);r=l.clone().dot(e);l.sub(e.clone().multiplyScalar(r));e=l.length();e>c&&(g=a[d],c=e,q=l)}c=g.clone().cross(f).normalize();g=new THREE.Plane(c,-f.x*c.x-f.y*c.y-f.z*c.z);
for(var p,d=c=0;d<a.length;d++)e=g.distanceToPoint(a[d]),e>c&&(p=a[d],c=e);a=f.clone().multiplyScalar(0.5);b=b[1].clone().add(a);p=g.orthoPoint(p);return new OBB(b,new THREE.Quaternion,a,q,p.negate())};
OBB.prototype.updateDerived=function(a){if(a||!this._position.equals(this.prev_position)||!this._orientation.equals(this.prev_orientation)){var b=(new THREE.Matrix3).makeRotationFromQuaternion(this._orientation);this._derived_axis=new THREE.Matrix3(this.u.x,this.v.x,this.w.x,this.u.y,this.v.y,this.w.y,this.u.z,this.v.z,this.w.z);this._derived_axis=b.multiply(this._derived_axis)}ConvexHull.prototype.updateDerived.call(this,a)};
OBB.prototype.calculateInertiaTensor=function(a,b,c,d,f){var e=this.u.length(),g=this.v.length(),h=this.w.length();if(c)return f.set(4*a*(g*g+h*h)/12,0,0,0,4*a*(e*e+h*h)/12,0,0,0,4*a*(g*g+e*e)/12);var q=Math.atan(e-b.x)-Math.atan(-e-b.x),l=Math.atan(g-b.y)-Math.atan(-g-b.y),r=Math.atan(h-b.z)-Math.atan(-h-b.z);a=d*q*(2*r*l+l*h+r*g);c=d*l*(2*r*q+q*h+r*e);d=d*r*(2*q*l+q*g+l*e);e=log((b.x-e)*(b.x-e)+1)-log((b.x+e)*(b.x+e)+1);g=log((b.y-g)*(b.y-g)+1)-log((b.y+g)*(b.y+g)+1);b=log((b.z-h)*(b.z-h)+1)-log((b.z+
h)*(b.z+h)+1);h=Ixy=-(g*e*r)/4;l=Izx=-(b*e*l)/4;q=Izy=-(b*g*q)/4;f.set(a,Ixy,l,h,c,q,Izx,Izy,d)};OBB.prototype.getDerivedAxis=function(){this.updateDerived();return this._derived_axis};
OBB.prototype.isSeparatingAxisOBB=function(a,b,c,d,f){if(0.1>a.lengthSq())return!1;for(var e=b.getDerivedAxis().elements,g=c.getDerivedAxis().elements,h=0,q=0,l=0;l<e.length-2;l+=3)h+=Math.abs(e[l]*a.x+e[l+1]*a.y+e[l+2]*a.z);for(l=0;l<g.length-2;l+=3)q+=Math.abs(g[l]*a.x+g[l+1]*a.y+g[l+2]*a.z);c=Math.abs(b.getPosition().sub(c.getPosition()).dot(a));b=c>h+q;void 0!==d&&(h=c-h-q,q=f&&void 0===d._has_edge?COLLISION_THRESHOLD:0,void 0===d._shortest_dist||0>=d._shortest_dist&&h>=d._shortest_dist+q||0<
d._shortest_dist&&0<h&&h<=d._shortest_dist-q)&&(d._has_edge=f,d._shortest_dist=h,d.axis=a.clone());return b};
OBB.prototype.collideOBB=function(a,b){var c=new THREE.Vector3;c.subVectors(a._position,this._position);for(var d=this.getDerivedVertices(),f=a.getDerivedVertices(),e=0;3>e;e++){var g=this._faces[e].getNormal(d);if(this.isSeparatingAxisOBB(g,this,a,b))return!1;g=a._faces[e].getNormal(f);if(this.isSeparatingAxisOBB(g,a,this,b))return!1;for(var h=0;3>h;h++){var g=f[a._edges[h].p2].clone().sub(f[a._edges[h].p1]),q=d[this._edges[e].p2].clone().sub(d[this._edges[e].p1]),g=(new THREE.Vector3).crossVectors(q,
g).normalize();if(this.isSeparatingAxisOBB(g,this,a,b,!0))return!1}}if(void 0!==b){b._shortest_dist=void 0;if(b._has_edge)for(e=0;e<this._edges.length;e++)for(h=0;h<a._edges.length;h++){if(l=b.axis.clone().negate(),g=f[a._edges[h].p2].clone().sub(f[a._edges[h].p1]),q=d[this._edges[e].p2].clone().sub(d[this._edges[e].p1]),g=(new THREE.Vector3).crossVectors(q,g).normalize(),0.01>g.clone().sub(b.axis).lengthSq()||0.01>g.clone().sub(l).lengthSq())0>c.dot(g)&&g.negate(),this.isSeparatingAxis(g,this,a,
b,this._edges[e],a._edges[h])}else for(e=0;e<this._faces.length;e++){var l=b.axis.clone().negate(),g=this._faces[e].getNormal(d);(0.01>g.clone().sub(b.axis).lengthSq()||0.01>g.clone().sub(l).lengthSq())&&this.isSeparatingAxis(g,this,a,b,this._faces[e],void 0);l=b.axis.clone().negate();g=a._faces[e].getNormal(f);(0.01>g.clone().sub(b.axis).lengthSq()||0.01>g.clone().sub(l).lengthSq())&&this.isSeparatingAxis(g,a,this,b,void 0,a._faces[e])}if(void 0===b._shortest_dist)return!1;this.updateReport(b,a)}return!0};
var physics_mode={STATIC:0,KINEMATIC:1,DYNAMIC:2};
function PhysicalObject(a){a=a||{};this._position=new THREE.Vector3;this._prev_position=new THREE.Vector3;this._orientation=new THREE.Quaternion;this._prev_orientation=new THREE.Quaternion;this._id=void 0;this._mode=void 0===a.mode?physics_mode.DYNAMIC:a.mode;this._is_sleeping=!1;this._com=a.center_of_mass||new THREE.Vector3;this._mass=a.mass||0;this._inertia_tensor=new THREE.Matrix3;this._global_inertia_tensor=new THREE.Matrix3;this._density_factor=0;this._uniform_density=void 0===a._uniform_density?
!0:a._uniform_density;this._need_density_update=!0;this.restitution=a.restitution||0;this.friction=a.friction||0;this._velocity=new THREE.Vector3;this._angular_velocity=new THREE.Vector3;this._rolling_velocities=new AssociativeArray;this.force=new THREE.Vector3;this.torque=new THREE.Vector3;this.acceleration=new THREE.Vector3;this.angular_acceleration=new THREE.Vector3;this._immovable_direction=new THREE.Vector3;this._immovable_direction_new=new THREE.Vector3;this.sphere=a.sphere;this.collider=a.collider;
this.collidable=void 0===a.collidable?!0:!1;void 0!==this.sphere&&this.sphere.bind(this);this.collider.bind(this);this.children=[];this.collider instanceof ConvexHull&&this.collider.setCenter(this._com.x,this._com.y,this._com.z);this.contact_points=new AssociativeArray;this.viz_node=new THREE.Object3D;this.velocity_mesh=new THREE.Line(new THREE.Geometry,new THREE.LineBasicMaterial({color:2081333,opacity:1}));this.viz_node.add(this.velocity_mesh);this.angular_mesh=new THREE.Line(new THREE.Geometry,
new THREE.LineBasicMaterial({color:14333071,opacity:1}));this.viz_node.add(this.angular_mesh);this.addEventListener=THREE.EventDispatcher.prototype.addEventListener;this.hasEventListener=THREE.EventDispatcher.prototype.hasEventListener;this.removeEventListener=THREE.EventDispatcher.prototype.removeEventListener;this.removeAllEventListeners=THREE.EventDispatcher.prototype.removeAllEventListeners;this.dispatchEvent=THREE.EventDispatcher.prototype.dispatchEvent}
PhysicalObject.prototype={constructor:PhysicalObject,physicalObjectPoseChangedEvent:{type:"physicalobjectposechanged"},collisionEnteredEvent:{type:"collision",source:void 0,collided_object:void 0},POSITION_CHANGE_THRES:1E-4,ORIENTATION_CHANGE_THRES:0.99,destroy:function(){void 0!==this.viz_node.parent&&this.viz_node.parent.remove(this.viz_node);for(var a=0;a<this.viz_node.children.length;a++)this.viz_node.remove(this.viz_node.children[a]);void 0!==this.collider&&this.collider.destroy();void 0!==this.sphere&&
this.sphere.destroy();this.removeAllEventListeners()},setMode:function(a){this._mode=a},isKinematic:function(){return this._mode===physics_mode.KINEMATIC},isDynamic:function(){return this._mode===physics_mode.DYNAMIC},isStatic:function(){return this._mode===physics_mode.STATIC},calculateInertiaTensor:function(){this.collider.calculateInertiaTensor(this._mass,this._com,this._uniform_density,this._density_factor,this._inertia_tensor)},getGlobalInertiaTensor:function(){this.updateDensity();var a=new THREE.Matrix3;
a.makeRotationFromQuaternion(this._orientation);for(var b=0;b<a.elements.length;b++)1E-4>Math.abs(a.elements[b])&&(a.elements[b]=0);return a.clone().multiply(this._inertia_tensor).multiply(a.clone().transpose())},updateDensity:function(){this._need_density_update&&(this.calculateInertiaTensor(),this._uniform_density||this.calculateDensityFactor(),this._need_density_update=!1)},setVelocity:function(a,b,c){this._velocity.set(a,b,c)},getVelocity:function(){var a=this._velocity.clone();this._rolling_velocities.forEach(function(b,
c){a.add(b)});return a},getAngularVelocity:function(){return this._angular_velocity.clone()},getAngularMass:function(a){if(this.collider instanceof Plane)return this._mass;if(0.9>a.lengthSq())return 0;this.updateDensity();var b=a.clone().applyMatrix3(this._inertia_tensor);return a.dot(b)},applyForce:function(a,b){void 0!==b&&this.applyTorque(a,b);this._is_sleeping=!1;this.force.add(a)},applyTorque:function(a,b){var c=b.clone().sub(this._com).applyQuaternion(this._orientation).cross(a);this._is_sleeping=
!1;this.torque.add(c.applyQuaternion(this._orientation.clone().inverse()))},calculateDensityFactor:function(){if(void 0!==this.OBB&&!this.uniform_density){var a=(Math.atan(-this._com.x-this.OBB.u)-Math.atan(this.OBB.u-this._com.x))*(Math.atan(-this._com.y-this.OBB.v)-Math.atan(this.OBB.v-this._com.y))*(Math.atan(-this._com.z-this.OBB.w)-Math.atan(this.OBB.w-this._com.z));this._density_factor=this._mass/a}},setCenterOfMass:function(a){this._com.set(a.x,a.y,a.z);this._need_density_update=!0;void 0===
this.OBB||a.equals(this.OBB.position)||(this._uniform_density=!1)},setMass:function(a){this._mass=a;this._need_density_update=!0},bind:function(a){this._id=a._id;this._position=a._position;this._orientation=a._orientation;void 0!==this.sphere&&this.sphere.bind(this);void 0!==this.OBB&&this.OBB.bind(this);void 0!==this.convex_hull&&this.convex_hull.bind(this);void 0!==this.collider&&this.collider.bind(this)},unbind:function(){this._id=void 0;this._position=this._position.clone();this._orientation=
this._orientation.clone();void 0!==this.sphere&&this.sphere.unbind(this);void 0!==this.OBB&&this.OBB.unbind(this);void 0!==this.convex_hull&&this.convex_hull.unbind(this);void 0!==this.collider&&this.collider.unbind(this)},isBound:function(a){return this._id===a._id},getExposedArea:function(){return void 0!==this.collider?this.collider.getExposedArea(this._velocity):0},setPosition:function(a,b,c){this._position.set(a,b,c);this._prev_position.clone().sub(this._position).lengthSq()>this.POSITION_CHANGE_THRES&&
(this._prev_position.set(a,b,c),this.dispatchEvent(this.physicalObjectPoseChangedEvent))},setOrientation:function(a,b,c,d){this._orientation.set(a,b,c,d);Math.abs(this._prev_orientation.dot(this._orientation))<this.ORIENTATION_CHANGE_THRES&&(this._prev_orientation.set(a,b,c,d),this.dispatchEvent(this.physicalObjectPoseChangedEvent))},rotate:function(a){a=a.clone().multiply(this._orientation);this._orientation.set(a.x,a.y,a.z,a.w);Math.abs(this._prev_orientation.dot(this._orientation))<this.ORIENTATION_CHANGE_THRES&&
(this._prev_orientation.set(a.x,a.y,a.z,a.w),this.dispatchEvent(this.physicalObjectPoseChangedEvent))},getPosition:function(){return this._position.clone()},getOrientation:function(){return this._orientation.clone()},getDerivedCenterOfMass:function(){return this._com.clone().applyQuaternion(this._orientation).add(this._position)}};var COLLISION_THRESHOLD=0.1,ORTHOGONAL_THRESHOLD=0.01,LAG_THRESHOLD=0.1,NUM_GLOBAL_ITERATIONS=1;
function PhysicsEngine(a){function b(a,b){return{v:a.v.clone().add(a.acceleration.clone().multiplyScalar(b)),av:a.av.clone().add(a.angular_acceleration.clone().multiplyScalar(b)),acceleration:a.acceleration,angular_acceleration:a.angular_acceleration}}var c=new AssociativeArray,d=1/60,f=0,e=void 0!==a.gravity?a.gravity:new THREE.Vector3(0,-9.8,0);Math.pow(293.15/291.15,1.5);var g=a.collision_detector;if(void 0!==g){var h=new CollisionHandler(c);g.addEventListener("collisionentered",function(b){var d=
c[b.report.object1._id],e=c[b.report.object2._id];if(void 0!==d&&void 0!==e){d.collisionEnteredEvent.source=d;d.collisionEnteredEvent.collided_object=e;d.collisionEnteredEvent.report=b.report;d.dispatchEvent(d.collisionEnteredEvent);e.collisionEnteredEvent.source=e;e.collisionEnteredEvent.collided_object=d;e.collisionEnteredEvent.report=b.report;e.dispatchEvent(e.collisionEnteredEvent);var f=d.isKinematic(),g=e.isKinematic();d.isDynamic();e.isDynamic();void 0===d||(void 0===e||f&&g||!a.handle_collisions)||
(d.getAngularVelocity(),e.getAngularVelocity(),d.getVelocity(),e.getVelocity(),h.handleCollision(d,e,b))}});g.addEventListener("collisionexited",h.handleCollisionOut)}this.add=function(a){c.add(a._id,a)};this.remove=function(a){c.remove(a._id)};this.step=function(a){f+=a;if(!(f<d)){var l=f/d,h=Math.floor(l);a=d;f>LAG_THRESHOLD&&(h=1);f=(l-h)*d;for(l=0;l<h;l++)c.forEach(function(c,d){if(!c.isStatic()&&!c._is_sleeping){var f=c.getPosition();c.getOrientation();var g={v:c._velocity,av:c._angular_velocity,
acceleration:c.acceleration,angular_acceleration:c.angular_acceleration},l=b(g,a/2),h=b(l,a/2),r=b(h,a);c._velocity=g.v.add(l.v.multiplyScalar(2).add(h.v.multiplyScalar(2)).add(r.v)).divideScalar(6);c._angular_velocity=g.av.add(l.av.multiplyScalar(2).add(h.av.multiplyScalar(2)).add(r.av)).divideScalar(6);g=c.getVelocity().multiplyScalar(a);l=c.getAngularVelocity().multiplyScalar(a);c.setPosition(f.x+g.x,f.y+g.y,f.z+g.z);c.rotate((new THREE.Quaternion).setFromEuler(l));c.applyForce(e.clone().multiplyScalar(c._mass));
f=c.getExposedArea();c._velocity.clone().multiply(c._velocity).multiplyScalar(0.0011883392636394198*f/2);c.isDynamic()&&(c.acceleration=c.force.clone().divideScalar(c._mass),c.angular_acceleration=c.torque.clone().applyMatrix3(c.getGlobalInertiaTensor().clone().inverse()));c.velocity_mesh.geometry.vertices.length=0;c.velocity_mesh.geometry.vertices.push(c.getPosition());c.velocity_mesh.geometry.vertices.push(c.getPosition().add(c._velocity.clone().multiplyScalar(10)));c.velocity_mesh.geometry.verticesNeedUpdate=
!0;c.force.set(0,0,0);c.torque.set(0,0,0);c._immovable_direction.set(c._immovable_direction_new.x,c._immovable_direction_new.y,c._immovable_direction_new.z);c._immovable_direction_new.set(0,0,0)}}),g.update(c)}}}
function Entity(){this._id=Entity.prototype.countId++;this._position=new THREE.Vector3;this._prev_position=new THREE.Vector3;this._orientation=new THREE.Quaternion;this._prev_orientation=new THREE.Quaternion;this.physics=this.material=this._mesh=void 0;this._physicsEnabled=!1;this.bounding_volume=void 0;var a=this;this.onPhysicalObjectPoseChanged=function(b){a.physics.isBound(a)&&(a.entityPoseChangedEvent.object=a,a.dispatchEvent(a.entityPoseChangedEvent))};this.addEventListener=THREE.EventDispatcher.prototype.addEventListener;
this.hasEventListener=THREE.EventDispatcher.prototype.hasEventListener;this.removeEventListener=THREE.EventDispatcher.prototype.removeEventListener;this.removeAllEventListeners=THREE.EventDispatcher.prototype.removeAllEventListeners;this.dispatchEvent=THREE.EventDispatcher.prototype.dispatchEvent}
Entity.prototype={constructor:Entity,entityPoseChangedEvent:{type:"entityposechanged",object:void 0},physicsEnabledChangeEvent:{type:"physicsenabledchange",object:void 0,enabled:void 0},countId:0,POSITION_CHANGE_THRES:1E-4,ORIENTATION_CHANGE_THRES:0.99,destroy:function(){this._mesh.parent.remove(this._mesh);void 0!==this.physics&&this.physics.destroy();this.removeAllEventListeners()},attachPhysics:function(a){this.physics=a;this.bounding_volume=this.physics.collider;this.physics.bind(this);this.physics.addEventListener("physicalobjectposechanged",
this.onPhysicalObjectPoseChanged)},setMesh:function(a){this._mesh=a;this._mesh.position=this._position;this._mesh.useQuaternion=!0;this._mesh.quaternion=this._orientation},setBoundingVolume:function(a){this.bounding_volume=a},setPosition:function(a,b,c){this._position.set(a,b,c);this._prev_position.clone().sub(this._position).lengthSq()>this.POSITION_CHANGE_THRES&&(this._prev_position.set(a,b,c),this.entityPoseChangedEvent.object=this,this.dispatchEvent(this.entityPoseChangedEvent))},getPosition:function(){return this._position.clone()},
setOrientation:function(a,b,c,d){this._orientation.set(a,b,c,d);Math.abs(this._prev_orientation.dot(this._orientation))<this.ORIENTATION_CHANGE_THRES&&(this._prev_orientation.set(a,b,c,d),this.entityPoseChangedEvent.object=this,this.dispatchEvent(this.entityPoseChangedEvent))},getOrientation:function(){return this._orientation.clone()}};var i=0;
function Octree(a,b,c,d,f){this.id=i++;this.origin=b;this.halfwidth=c;this.halfheight=d;this.halfdepth=f;this.depth=null===a?0:a.depth+1;this.volumes=[];this.parent_node=a;this.children_nodes=[];this._all_volumes=new AssociativeArray;this._to_update=null===a?[]:a._to_update;this._leaves=[];this._leaves.push(this);this._need_all_volumes_update=this._need_leaves_update=!1;this.box=new OBB(b,new THREE.Quaternion,new THREE.Vector3(c,0,0),new THREE.Vector3(0,d,0),new THREE.Vector3(0,0,f));this.viz_node.add(this.box.mesh)}
Octree.prototype.constructor=Octree;Octree.prototype.volumes_per_node=1;Octree.prototype.max_depth=10;Octree.prototype.viz_node=new THREE.Object3D;
Octree.prototype.add=function(a){function b(){for(var b=c;null!==b;)b._need_all_volumes_update=!0,b=b.parent_node;c.volumes.push(a)}var c=this;if(this.intersects(a))if(this.depth>=this.max_depth)b();else if(0===this.children_nodes.length)this.volumes.length<this.volumes_per_node?b():(this.subdivide(),0!==this.volumes.length&&this.volumes.slice().forEach(function(a){c.remove(a);c.add(a)}),this.add(a));else{for(var d=-1,f=!1,e=0;e<this.children_nodes.length;e++)if(this.children_nodes[e].intersects(a)){if(-1!=
d){f=!0;break}d=e}f?b():-1!==d&&this.children_nodes[d].add(a)}};Octree.prototype.remove=function(a){var b=this;if(this.volumes.some(function(c,f){return c._id===a._id?(b.volumes.splice(f,1),!0):!1})){for(var c=this;null!==c;)c._need_all_volumes_update=!0,c=c.parent_node;return!0}for(c=0;c<this.children_nodes.length;c++)if(void 0!==this.children_nodes[c]._all_volumes[a._id]&&this.children_nodes[c].remove(a))return!0;return!1};Octree.prototype.find=function(a){if(this._all_volumes.isKey(a))return this._all_volumes[a][1]};
Octree.prototype.empty=function(){if(0<this.volumes.length)return!1;for(var a=0;a<this.children_nodes.length;a++)if(!this.children_nodes[a].empty())return!1;return!0};Octree.prototype.intersects=function(a){if(a instanceof ConvexHull){for(var b=a.getDerivedVertices(),c=b.length,d=0;d<c;d++)if(this.contains(b[d]))return!0;return this.box.collide(a)}return a instanceof Plane?this.box.collidePlane(a):!1};
Octree.prototype.contains=function(a){var b=new THREE.Vector3;b.subVectors(a,this.origin);return Math.abs(b.x)<=this.halfwidth&&Math.abs(b.y)<=this.halfheight&&Math.abs(b.z)<=this.halfdepth};Octree.prototype.containsVolume=function(a){if(a instanceof ConvexHull){a=a.getDerivedVertices();for(var b=a.length,c=0;c<b;c++)if(!this.contains[a[c]])return!1}return!0};
Octree.prototype.subdivide=function(){if(!(this.depth>=this.max_depth)){this.needLeavesUpdate();var a=this.halfwidth/2,b=this.halfheight/2,c=this.halfdepth/2;this.children_nodes[0]=new Octree(this,new THREE.Vector3(this.origin.x-a,this.origin.y+b,this.origin.z+c),a,b,c);this.children_nodes[1]=new Octree(this,new THREE.Vector3(this.origin.x+a,this.origin.y+b,this.origin.z+c),a,b,c);this.children_nodes[2]=new Octree(this,new THREE.Vector3(this.origin.x-a,this.origin.y-b,this.origin.z+c),a,b,c);this.children_nodes[3]=
new Octree(this,new THREE.Vector3(this.origin.x+a,this.origin.y-b,this.origin.z+c),a,b,c);this.children_nodes[4]=new Octree(this,new THREE.Vector3(this.origin.x-a,this.origin.y+b,this.origin.z-c),a,b,c);this.children_nodes[5]=new Octree(this,new THREE.Vector3(this.origin.x+a,this.origin.y+b,this.origin.z-c),a,b,c);this.children_nodes[6]=new Octree(this,new THREE.Vector3(this.origin.x-a,this.origin.y-b,this.origin.z-c),a,b,c);this.children_nodes[7]=new Octree(this,new THREE.Vector3(this.origin.x+a,
this.origin.y-b,this.origin.z-c),a,b,c)}};Octree.prototype.countChildrenIntersections=function(a,b){for(var c=[],d=0;d<this.children_nodes.length&&(this.children_nodes[d].intersects(b)&&c.push(d),c.length!==a);d++);return c};Octree.prototype.needLeavesUpdate=function(){for(var a=this;null!==a;)a._need_leaves_update=!0,a=a.parent_node};
Octree.prototype.updateChildrenEntities=function(){if(this._need_all_volumes_update){this._all_volumes=new AssociativeArray;for(var a=0;a<this.children_nodes.length;a++)this.children_nodes[a].updateChildrenEntities(),this._all_volumes.concat(this.children_nodes[a]._all_volumes);for(var b=this.volumes.length,a=0;a<b;a++)this._all_volumes.add(this.volumes[a]._id,[this.volumes[a],this]);this._need_all_volumes_update=!1}};
Octree.prototype.updateLeaves=function(){if(this._need_leaves_update){for(var a=this._leaves.length=0;a<this.children_nodes.length;a++)this.children_nodes[a].updateLeaves(),this._leaves=this._leaves.concat(this.children_nodes[a]._leaves);0===this.children_nodes.length&&this._leaves.push(this);this._need_leaves_update=!1}};
Octree.prototype.update=function(){function a(c){if(1>=c._all_volumes.length){(function p(a){for(var c=0;c<a.children_nodes.length;c++){p(a.children_nodes[c]);var d=b._leaves.indexOf(a.children_nodes[c]);-1!==d&&b._leaves.splice(d,1);a.children_nodes[c].box.destroy()}})(c);c.needLeavesUpdate();c.children_nodes.length=0;if(1===c._all_volumes.length){var d=c._all_volumes.get(0);d.value[1]!==c&&(c._all_volumes.add(d.key,[d.value[0],c]),c.add(d.value[0]))}null!==c.parent_node&&a(c.parent_node)}}var b=
this;b.updateChildrenEntities();for(var c=this._to_update.length,d=0;d<c;d++){var f=this._to_update[d];if(b._all_volumes.isKey(f._id)){var e=b._all_volumes[f._id],f=e[0],e=e[1],g,h=!1,q=e;if(e.contains(f)){for(;null!==q;)if(g=q.countChildrenIntersections(2,f),1===g.length){h=!0;if(e===q.children_nodes[g[0]])break;e.remove(f);q.children_nodes[g[0]].add(f);break}else if(null===q.parent_node&&0<g.length){e.remove(f);q.add(f);h=!0;break}else if(null===q.parent_node&&0===q.children_nodes.length&&q.intersects(f)){h=
!0;break}else q=q.parent_node;h||null===e||e.remove(f)}else{e.remove(f)||(b.updateChildrenEntities(),b.remove(f));for(;null!==q.parent_node;)q=q.parent_node;q.add(f)}}else b.add(f)}this._to_update.length=0;b.updateChildrenEntities();b.updateLeaves();this._leaves.forEach(function(b){a(b)})};Octree.prototype.pick=function(a){var b=[];this._all_volumes.forEach(function(a){b.push(a[0])});return a.intersectObjects(b)};
function SceneManager(a,b){var c=this;this.census=[];this.addToScene=function(b){a.add(b)};this.init=function(){};this.addEntity=function(a){c.addToScene(a._mesh);c.census[a._id]=a;void 0!==a.bounding_volume&&b.add(a.bounding_volume)};this.removeEntity=function(a){this.census[a._id]=void 0;b.remove(a);b.update()};this.getOctree=function(){return b};this.pick=function(a,c){var e=b.pick(a);return 0!==e.length?this.census[e[0].object._id]:void 0};this.findObjectsNear=function(a){var c=b.find(a),e=[];
if(void 0!==c)for(c._all_volumes.forEach(function(b,c){c!=a&&e.push(b[0])});null!==c.parent_node;){for(var g=c.parent_node.volumes.length,h=0;h<g;h++)c.parent_node.volumes[h]._id!==a&&e.push(c.parent_node.volumes[h]);c=c.parent_node}return e};this.update=function(){b.update()}}SceneManager.img_loader=new THREE.ImageLoader;
function DebugViewer(a){var b=new THREE.Object3D,c=physics_engine;a.addToScene(b);b.add(a.getOctree().viz_node);b.add(Volume.prototype.volumes_node);this.add=function(a){b.add(a)};b.add(c.viz_node);b.visible=!1;this.setOctreeVisible=function(b){a.getOctree().viz_node.visible=b};this.setVolumesVisible=function(a){Volume.prototype.volumes_node.visible=a};this.setVisible=function(a){b.visible=a}}
function World(){var a={type:"worldobjectcreated",object:void 0},b={type:"worldobjectdestroyed",object:void 0};this.addEventListener=THREE.EventDispatcher.prototype.addEventListener;this.hasEventListener=THREE.EventDispatcher.prototype.hasEventListener;this.removeEventListener=THREE.EventDispatcher.prototype.removeEventListener;this.dispatchEvent=THREE.EventDispatcher.prototype.dispatchEvent;this.sendObjectCreatedEvent=function(b){a.object=b;this.dispatchEvent(a)};this.sendObjectDestroyedEvent=function(a){b.object=
a;this.dispatchEvent(b)};this.update=function(){}}function Raycaster(a,b,c,d){this.ray=new THREE.Ray(a,b);0<this.ray.direction.lengthSq()&&this.ray.direction.normalize();this.near=c||0;this.far=d||Infinity}
(function(){var a=new THREE.Sphere,b=new THREE.Ray,c=new THREE.Plane,d=new THREE.Vector3,f=new THREE.Vector3,e=new THREE.Matrix4,g=function(a,b){return a.distance-b.distance},h=function(g,l,r){var n=g.mesh;if(n instanceof THREE.Particle){f.getPositionFromMatrix(n.matrixWorld);var p=l.ray.distanceToPoint(f);if(p>n.scale.x)return r;r.push({distance:p,point:n.position,face:null,object:g})}else if(n instanceof THREE.LOD)f.getPositionFromMatrix(n.matrixWorld),p=l.ray.origin.distanceTo(f),h(n.getObjectForDistance(p),
l,r);else if(n instanceof THREE.Mesh){n.updateMatrixWorld(!0);f.getPositionFromMatrix(n.matrixWorld);a.set(f,n.geometry.boundingSphere.radius*n.matrixWorld.getMaxScaleOnAxis());if(!l.ray.isIntersectionSphere(a))return r;var p=n.geometry,m=p.vertices,s=n.material instanceof THREE.MeshFaceMaterial,t=!0===s?n.material.materials:null,v=n.material.side,w,y,F,G=l.precision;e.getInverse(n.matrixWorld);b.copy(l.ray).applyMatrix4(e);for(var x=0,D=p.faces.length;x<D;x++){var u=p.faces[x],v=!0===s?t[u.materialIndex]:
n.material;if(void 0!==v){c.setFromNormalAndCoplanarPoint(u.normal,m[u.a]);var z=b.distanceToPlane(c);if(!(Math.abs(z)<G||0>z)){v=v.side;if(v!==THREE.DoubleSide&&(w=b.direction.dot(c.normal),!(v===THREE.FrontSide?0>w:0<w)))continue;if(!(z<l.near||z>l.far)){d=b.at(z,d);if(u instanceof THREE.Face3){if(v=m[u.a],w=m[u.b],y=m[u.c],!THREE.Triangle.containsPoint(d,v,w,y))continue}else if(u instanceof THREE.Face4){if(v=m[u.a],w=m[u.b],y=m[u.c],F=m[u.d],!THREE.Triangle.containsPoint(d,v,w,F)&&!THREE.Triangle.containsPoint(d,
w,y,F))continue}else throw Error("face type not supported");r.push({distance:z,point:l.ray.at(z),face:u,faceIndex:x,object:g})}}}}}};Raycaster.prototype.precision=1E-4;Raycaster.prototype.set=function(a,b){this.ray.set(a,b);0<this.ray.direction.length()&&this.ray.direction.normalize()};Raycaster.prototype.intersectObject=function(a,b){var c=[];h(a,this,c);c.sort(g);return c};Raycaster.prototype.intersectObjects=function(a,b){for(var c=[],d=0,e=a.length;d<e;d++)h(a[d],this,c);c.sort(g);return c}})();
function Projector(){THREE.Projector.call(this);this.pickingRay=function(a,b){a.z=-1;var c=new THREE.Vector3(a.x,a.y,1);this.unprojectVector(a,b);this.unprojectVector(c,b);c.sub(a).normalize();return new Raycaster(a,c)}}Projector.prototype=Object.create(THREE.Projector);Projector.prototype.constructor=Projector;
